<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã‡ark EtkinliÄŸi</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Kid Theme -->
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!-- Confetti Library for Rewards -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        .wheel-container {
            position: relative;
            width: 600px;
            /* Increased from 400px */
            height: 600px;
            /* Increased from 400px */
            margin: 0 auto;
            margin-bottom: 30px;
            /* Space for button */
        }

        #wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 10px solid #FFFFFF;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            /* Ease-out will be handled in JS for more control */
            background-color: #FFD93D;
            overflow: hidden;
            position: relative;
        }

        .segment {
            position: absolute;
            top: 0;
            left: 50%;
            width: 50%;
            height: 50%;
            transform-origin: 0% 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .segment span {
            position: absolute;
            left: -100%;
            width: 200%;
            text-align: center;
            transform: rotate(45deg) translate(20px, 80px);
            /* Adjust based on segment size */
            font-weight: bold;
            font-size: 1.5rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }

        #pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 50px;
            background-color: #2D3436;
            /* Soft Dark Color */
            clip-path: polygon(50% 100%, 0 0, 100% 0);
            z-index: 10;
            filter: drop-shadow(0 6px 6px rgba(0, 0, 0, 0.6));
        }

        #spinBtn {
            transition: all 0.3s ease;
        }

        #spinBtn:hover {
            opacity: 1 !important;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4) !important;
            background-color: #4ADE80 !important;
            /* Lighter Green on Hover */
            border-color: #4ADE80 !important;
        }

        #spinBtn:disabled {
            background-color: #95a5a6 !important;
            /* Gray when disabled */
            border-color: #7f8c8d !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Checkbox customization in Sidebar */
        .sidebar-settings {
            width: 100%;
            background-color: #f2f2f2;
            /* Light cyan matching some theme elements */
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .form-check-input {
            width: 1.5em;
            height: 1.5em;
            cursor: pointer;
            float: none;
            /* Center it */
            margin-right: 5px;
        }

        .form-check-label {
            font-size: 1.2rem;
            font-weight: bold;
            color: #242424;
            /* Stack */
            margin-top: 5px;
        }

        /* Border Radius Restoration */
        .main-content-kid {
            /* Default form style.css is border-radius: 40px */
            /* We previously removed it, now we just let it be or ensure it's there */
            border-radius: 40px !important;
        }

        .game-board {
            background-image: url('../../assets/img/cark_etkinligi/bg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 0px 0px 30px 30px;
            /* Slight radius for inner board if needed, or inherit */
            margin: 0;
            /* REMOVED margin to allow full cover */
            width: 100%;
            height: 100%;
            flex-grow: 1;
            overflow: hidden;
            /* Ensure rounded corners clip content */
        }
    </style>
</head>

<body>

    <div class="game-container-fixed">

        <!-- Sidebar (Left) -->
        <div class="sidebar-kid">

            <!-- Top: Settings -->
            <div class="sidebar-settings">
                <i class="bi bi-gear-fill mb-2" style="font-size: 2rem; color: #242424;"></i>
                <div class="form-check d-flex flex-column align-items-center justify-content-center">
                    <input class="form-check-input" type="checkbox" id="deleteSegmentCheck">
                </div>
                <p>
                    <label class="form-check-label" for="deleteSegmentCheck">
                        BÃ¶lme silinsin
                    </label>
                </p>
            </div>

            <!-- Navigation Buttons -->
            <div class="nav-buttons-container" style="margin-top: auto;">

                <!-- Instructions Button -->
                <button class="btn btn-kid btn-info-kid btn-icon-only" data-bs-toggle="modal"
                    data-bs-target="#instructionsModal" title="YÃ¶nerge">
                    <i class="bi bi-question-lg"></i>
                </button>

                <!-- Reload/Retry Button -->
                <button onclick="location.reload()" class="btn btn-kid btn-primary-kid btn-icon-only"
                    title="Yeniden BaÅŸlat">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>

                <!-- Home Button -->
                <a href="../../index.html" class="btn btn-kid btn-danger btn-icon-only" title="Anasayfa">
                    <i class="bi bi-house-fill"></i>
                </a>
            </div>

        </div>

        <div class="main-content-kid">

            <!-- New Top Header -->
            <div class="game-header">
                <h2 class="game-title">Ã‡ark EtkinliÄŸi</h2>
            </div>

            <!-- Inner Game Board -->
            <div class="game-board"
                style="padding: 0; position: relative; display: flex; align-items: center; justify-content: center;">
                <!-- Changed padding to 0 and centered to allow BG to fill -->

                <div class="wheel-wrapper d-flex flex-column align-items-center justify-content-center w-100 h-100">
                    <div class="wheel-container">
                        <div id="pointer"></div>
                        <canvas id="wheelCanvas" width="600" height="600"></canvas> <!-- Updated size -->
                    </div>

                    <!-- Button centered below -->
                    <button id="spinBtn" class="btn btn-kid btn-success-kid px-5 py-3"
                        style="font-size: 2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 20; opacity: 1 !important;">
                        Ã‡EVÄ°R <i class="bi bi-arrow-repeat"></i>
                    </button>

                </div>

            </div>

        </div>

    </div>

    <!-- Instructions Modal -->
    <div class="modal fade" id="instructionsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content modal-content-kid" style="border-color: #4CC9F0;">
                <div class="modal-header">
                    <h5 class="modal-title display-6">NasÄ±l OynanÄ±r?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-5">
                    <div class="row align-items-center">
                        <div class="col-4 text-center">
                            <i class="bi bi-pie-chart-fill text-info" style="font-size: 6rem;"></i>
                        </div>
                        <div class="col-8 text-start">
                            <ul class="list-unstyled" style="font-size: 1.2rem;">
                                <li class="mb-2">ðŸ‘‰ <strong>AdÄ±m 1:</strong> Ã‡arkÄ± Ã§evirmek iÃ§in butona bas.</li>
                                <li class="mb-2">ðŸ‘‰ <strong>AdÄ±m 2:</strong> Gelen kelimeyi oku.</li>
                                <li class="mb-2">ðŸ‘‰ <strong>Ä°pucu:</strong> "BÃ¶lme silinsin" kutusunu iÅŸaretlersen,
                                    gelen kelime Ã§arktan silinir!</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-kid btn-primary-kid" data-bs-dismiss="modal">AnladÄ±m</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>window.ASSETS_PATH = '../../assets/';</script>
    <script src="../../assets/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('wheelCanvas');
            const ctx = canvas.getContext('2d');
            const spinBtn = document.getElementById('spinBtn');
            const deleteCheck = document.getElementById('deleteSegmentCheck');

            // Audio
            const spinAudio = new Audio('../../assets/audio/cark.wav');
            spinAudio.loop = true;
            spinAudio.volume = 1.0;
            spinAudio.load(); // Preload
            spinAudio.onerror = (e) => console.error("Audio Load Error:", e);

            let segments = ["nane", "nene", "annene", "en", "ne", "anne"];
            // Soft Pastel Colors matching Kid Theme
            const colors = ['#FF9F1C', '#2EC4B6', '#CBF3F0', '#FFBF69', '#FF4D6D', '#A0C4FF'];

            let currentAngle = 0;
            let isSpinning = false;
            let spinSpeed = 0;
            let lastTimestamp = 0;
            // Physics constants
            // Speed in radians per ms? No, let's stick to per frame but normalized?
            // Simple: radians per second.

            function drawWheel() {
                if (segments.length === 0) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = "40px Arial"; /* Larger font */
                    ctx.fillStyle = "#333";
                    ctx.textAlign = "center";
                    ctx.fillText("Bitti!", canvas.width / 2, canvas.height / 2);
                    return;
                }

                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = canvas.width / 2 - 10; // Margin
                const arcSize = (2 * Math.PI) / segments.length;

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                segments.forEach((segment, index) => {
                    const angle = currentAngle + index * arcSize;

                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, angle, angle + arcSize);
                    ctx.fillStyle = colors[index % colors.length];
                    ctx.fill();
                    ctx.stroke();
                    ctx.save();

                    // Text
                    ctx.translate(centerX, centerY);
                    ctx.rotate(angle + arcSize / 2);
                    ctx.textAlign = "right";
                    ctx.fillStyle = "white";
                    ctx.font = "bold 32px Arial"; // Larger font for larger wheel
                    ctx.shadowColor = "rgba(0,0,0,0.5)";
                    ctx.shadowBlur = 4;
                    ctx.fillText(segment, radius - 30, 10);
                    ctx.restore();
                });
            }

            function spin() {
                if (isSpinning) return;

                // Initial speed: 15 to 25 radians per second (approx 2.5 to 4 rounds per sec)
                spinSpeed = 15 + Math.random() * 10;
                isSpinning = true;
                spinBtn.disabled = true;
                spinAudio.currentTime = 0;
                spinAudio.play().catch(e => console.log("Audio play failed interaction required", e));

                lastTimestamp = performance.now();
                requestAnimationFrame(animate);
            }

            function stopSpin() {
                isSpinning = false;
                spinBtn.disabled = false;
                spinAudio.pause();
                spinAudio.currentTime = 0;

                // Calculate winner
                const arcSize = (2 * Math.PI) / segments.length;
                // Normalize angle to [0, 2PI)
                let normalizedAngle = currentAngle % (2 * Math.PI);
                if (normalizedAngle < 0) normalizedAngle += 2 * Math.PI;

                // The pointer is at 270 degrees (3PI/2) or -PI/2.
                // We need to find which segment covers this angle.
                // A segment i covers [angle + i*arc, angle + (i+1)*arc]
                // So we want i such that: angle + i*arc <= target <= angle + (i+1)*arc
                // i*arc <= target - angle <= (i+1)*arc
                // So i = floor((target - angle) / arc)
                // But we need to handle wrapping.

                // Let's us the 3PI/2 target
                const target = 3 * Math.PI / 2;

                // Effective angle of the pointer relative to the start of the first segment (which is at currentAngle)
                // We want the offset from currentAngle to target.
                // (target - currentAngle)
                let relativeAngle = (target - currentAngle) % (2 * Math.PI);
                if (relativeAngle < 0) relativeAngle += 2 * Math.PI;

                const winningIndex = Math.floor(relativeAngle / arcSize) % segments.length;

                // Confetti
                confetti({
                    particleCount: 150,
                    spread: 80,
                    origin: { y: 0.6 }
                });

                // Handle Delete
                if (deleteCheck.checked) {
                    setTimeout(() => {
                        segments.splice(winningIndex, 1);
                        drawWheel();
                        if (segments.length === 0) {
                            spinBtn.disabled = true;
                        }
                    }, 1000);
                }
            }

            function animate(timestamp) {
                if (!isSpinning) return;

                const deltaTime = (timestamp - lastTimestamp) / 1000; // seconds
                lastTimestamp = timestamp;

                // Deceleration: reduce speed by fraction per second or constant friction?
                // Exponential decay is smoother usually.
                // Speed = Speed * (decay ^ deltaTime)
                // If we want it to last ~5 seconds.
                // 20 * (k^5) < 0.1 -> k^5 < 0.005 -> k < 0.3? Too fast.
                // Let's try subtracting constant friction for linear stop (wheel heavy feel)
                // or exponential.

                // Let's use simple exponential heavily tuned.
                // Reduce speed by 30% per second? -> factor 0.7
                // 20 -> 14 -> 9.8 -> 6.8 -> 4.7 -> 3.3 -> 2.3 -> 1.6 -> 1.1 -> 0.7 (stop) ~9 sec

                spinSpeed *= Math.pow(0.5, deltaTime); // Halves speed every second?
                // Maybe a bit faster decay.

                // To guarantee stop:
                if (spinSpeed < 0.1) {
                    stopSpin();
                    return;
                }

                currentAngle += spinSpeed * deltaTime;
                drawWheel();

                requestAnimationFrame(animate);
            }

            spinBtn.addEventListener('click', spin);

            // Initial draw
            drawWheel();

        });
    </script>
</body>

</html>