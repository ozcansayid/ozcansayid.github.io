<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devreyi Tamamla</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Fonts (Global Styles) -->

    <!-- Kid Theme -->
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!-- Game Style -->
    <link rel="stylesheet" href="style.css">
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* Custom Modal Styles (Replacing Bootstrap Modals) */
        .custom-modal-overlay {
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .custom-modal-content {
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            animation: popIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            border: 4px solid #4CC9F0;
            background: white;
            padding: 2rem;
            text-align: center;
            max-width: 80%;
        }

        @keyframes popIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Audio Slider Styles */
        .nav-buttons-container {
            overflow: visible !important;
        }

        .audio-slider-popup {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 110px;
            height: auto;
            background-color: #343a40;
            border-radius: 12px;
            padding: 8px 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            margin-bottom: 12px;
            transition: all 0.2s ease;
            z-index: 999;
        }

        .audio-slider-popup.show {
            opacity: 1;
            visibility: visible;
            bottom: 115%;
        }

        .audio-slider-popup::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: #343a40 transparent transparent transparent;
        }

        #volume-val-display {
            color: #fff;
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .slider-track-wrapper {
            width: 100%;
            display: flex;
            align-items: center;
        }

        .horizontal-range {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #555;
            outline: none;
            cursor: pointer;
        }

        .horizontal-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            border: 2px solid #ddd;
        }
    </style>
</head>

<body>
    <div class="game-container-fixed">

        <!-- Sidebar (Left) -->
        <div class="sidebar-kid">

            <!-- Combined Level and Audio Control -->
            <div class="lives-container"
                style="background: var(--card-bg); padding: 15px; border-radius: 20px; text-align: center;">
                <div class="lives-label">DÜZEY</div>
                <div style="font-size: 2rem; color: var(--primary-color); font-weight: 700; margin-bottom: 10px;"
                    id="levelDisplay">1/5</div>

                <!-- Control Button: Replay Audio -->
                <button class="btn btn-kid w-100 p-2 d-flex align-items-center justify-content-center"
                    id="btn-replay-sound" title="Sesi Tekrar Çal"
                    style="border-radius: 15px; background-color: #FFC107; color: white; border: none;">
                    <i class="bi bi-volume-up-fill fs-3"></i>
                </button>
            </div>

            <!-- Bottom: Navigation Buttons -->
            <div class="nav-buttons-container" style="position: relative; overflow: visible !important;">

                <!-- Audio Control (TOP) -->
                <div class="position-relative mb-2 d-flex justify-content-center">

                    <!-- Slider Popup (Horizontal) -->
                    <div id="audio-slider-container" class="audio-slider-popup">
                        <div id="volume-val-display">30</div>
                        <div class="slider-track-wrapper">
                            <input type="range" id="volume-range" class="horizontal-range" min="0" max="100" value="30">
                        </div>
                    </div>

                    <!-- Toggle Button (Always Green, White Icon) -->
                    <button id="btn-audio-toggle" class="btn btn-kid btn-icon-only" title="Ses Ayarı"
                        style="background-color: #2ecc71 !important; color: white !important; border: none !important;">
                        <i class="bi bi-volume-up-fill"></i>
                    </button>

                </div>

                <button onclick="location.reload()" class="btn btn-kid btn-primary-kid btn-icon-only"
                    title="Yeniden Başlat">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>

                <!-- Instructions Button -->
                <button class="btn btn-kid btn-info-kid btn-icon-only" title="Yönerge"
                    onclick="HeceSozcukInstruction.init()">
                    <i class="bi bi-question-lg"></i>
                </button>

                <!-- Fullscreen -->
                <button id="btn-fullscreen" class="btn btn-kid btn-icon-only"
                    style="background-color: #6f42c1; color: white; border: none;" title="Tam Ekran">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
        </div>

        <!-- Main Content (Right) -->
        <div class="main-content-kid">

            <!-- Header -->
            <div class="game-header">
                <h2 class="game-title">Hece-Sözcük Oluşturalım</h2>
                <div class="game-nav">

                    <a href="#" class="btn-nav-flat btn-nav-home" title="Anasayfa"
                        onclick="navigateHome(); return false;">
                        <i class="bi bi-house-fill"></i>
                    </a>
                    <button onclick="navigatePrev()" game_id', 1, 'subtract' )" class="btn-nav-flat" title="Önceki">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button onclick="navigateNext()" game_id', 1, 'add' )" class="btn-nav-flat" title="Sonraki">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Game Board (Template Container) -->
            <div class="game-board" style="flex-direction: column; justify-content: center;">

                <!-- Circuit Wrapper: Reusing the game logic area -->
                <!-- Circuit Wrapper -->
                <div class="circuit-wrapper"
                    style="justify-content: flex-start; padding-top: 20px; flex-direction: column; align-items: center;">
                    <!-- Circuit Area -->
                    <div class="circuit-container"
                        style="position: relative; text-align: center; display: flex; justify-content: center; height: auto;">
                        <img id="circuit-image" src="../../assets/img/devre_bos.png" alt="Devre" class="img-fluid"
                            style="max-height: 450px; width: auto; object-fit: contain;">

                        <!-- HTML Overlays for Drop Zones - Positioned on bottom cables -->
                        <!-- Adjusted bottom % and gap to fit cables. -->
                        <div class="drop-zones-overlay"
                            style="position: absolute; bottom: 3%; width: 100%; display: flex; justify-content: center; gap: 50px; align-items: flex-end;">
                            <div class="drop-zone" id="slot-0" data-index="0"></div>
                            <div class="drop-zone" id="slot-1" data-index="1"></div>
                        </div>
                    </div>

                    <!-- Result/Target Word Area (Inside wrapper) -->
                    <div id="target-word-display" class="hidden text-center mt-2 mb-3">
                    </div>

                    <!-- Draggable Options Area -->
                    <div class="options-container mt-4">
                        <div class="d-flex justify-content-center gap-3 flex-wrap w-100" id="options-wrapper">
                            <!-- Options generated by JS -->
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
    </div>
    </div>

    <!-- Custom Modal Structure (Hidden by default) -->
    <!-- Custom Modal Structure (Hidden by default) -->

    <!-- Custom Modal Structure (Hidden by default) -->
    <div id="custom-modal-template" style="display: none;">
        <div class="custom-modal-overlay"
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px) !important; z-index: 2000; display: flex; align-items: center; justify-content: center;">
            <div class="custom-modal-content"
                style="background: white; padding: 2.5rem; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; max-width: 80%; border: 5px solid #2ec4b6;">
                <h2 class="modal-title display-6 fw-bold mb-4" style="color: #2c3e50;"></h2>
                <div class="modal-body-content mb-5" style="font-size: 1.5rem; color: #4a4a4a; line-height: 1.6;"></div>
                <div class="mt-4">
                    <button class="btn btn-primary-kid btn-lg px-5 py-3 rounded-pill shadow-sm fw-bold"
                        onclick="closeCustomModal()">TAMAM</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Custom Modal Structure (Hidden by default) -->
    <div id="custom-modal-template" style="display: none;">
        <div class="custom-modal-overlay"
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px) !important; z-index: 2000; display: flex; align-items: center; justify-content: center;">
            <div class="custom-modal-content"
                style="background: white; padding: 2.5rem; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; max-width: 80%; border: 5px solid #2ec4b6;">
                <h2 class="modal-title display-6 fw-bold mb-4" style="color: #2c3e50;"></h2>
                <div class="modal-body-content mb-5" style="font-size: 1.5rem; color: #4a4a4a; line-height: 1.6;"></div>
                <div class="mt-4">
                    <button class="btn btn-primary-kid btn-lg px-5 py-3 rounded-pill shadow-sm fw-bold"
                        onclick="closeCustomModal()">TAMAM</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../../assets/js/main.js"></script>
    <script src="game.js"></script>
    <script src="intro.js"></script>

    <script>
        // Start Overlay Logic
        window.addEventListener('load', function () {
            // Intro.js handles the overlay
        });

        // --- Custom Modal Helpers ---
        window.showCustomModal = function (title, content) {
            const wrapper = document.querySelector('.game-board') || document.querySelector('.game-board-wrapper') || document.body;
            if (!wrapper) return;

            // Remove existing if any
            const existing = document.getElementById('active-custom-modal');
            if (existing) existing.remove();

            // Template Handling
            const templateEl = document.getElementById('custom-modal-template');
            if (!templateEl) { console.warn('Modal template missing'); return; }

            const template = templateEl.firstElementChild.cloneNode(true);
            template.id = 'active-custom-modal';
            template.querySelector('.modal-title').innerText = title;
            template.querySelector('.modal-body-content').innerHTML = content;

            const modalBox = template.querySelector('.custom-modal-content');

            // STANDARD SIZE LOGIC
            if (title === "Nasıl Oynanır?") {
                modalBox.style.width = '900px';
                modalBox.style.maxWidth = '95%';
                modalBox.style.minHeight = '550px';
                modalBox.style.height = 'auto'; // Auto allows expansion
                modalBox.style.display = 'block';
                modalBox.style.padding = '3rem';
            } else {
                modalBox.style.width = '500px';
                modalBox.style.maxWidth = '90%';
                modalBox.style.minHeight = '500px';
                modalBox.style.height = 'auto';
                modalBox.style.display = 'flex';
                modalBox.style.flexDirection = 'column';
                modalBox.style.justifyContent = 'center';
                modalBox.style.alignItems = 'center';
                modalBox.style.padding = '2rem';
            }

            wrapper.appendChild(template);
        };

        window.closeCustomModal = function () {
            const existing = document.getElementById('active-custom-modal');
            if (existing) existing.remove();
            if (typeof stopInstruction === 'function') stopInstruction();
        };

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>window.ASSETS_PATH = '../../assets/';</script>
    <script src="../../assets/js/main.js"></script>
    <script src="game.js"></script>
    <script src="intro.js"></script>
    <script src="instruction.js"></script>

    <script>
        // Storyline Integration Helper
        function updateStorylineVariable(varName, value, operation = 'set') {
            try {
                var player = null;
                if (window.GetPlayer) {
                    player = window.GetPlayer();
                } else if (window.parent && window.parent.GetPlayer) {
                    player = window.parent.GetPlayer();
                }

                if (player) {
                    if (operation === 'set') {
                        player.SetVar(varName, value);
                        console.log(`Storyline variable '${varName}' set to: ${value}`);
                    } else if (operation === 'add') {
                        var current = player.GetVar(varName);
                        if (typeof current === 'number') {
                            player.SetVar(varName, current + value);
                            console.log(`Storyline variable '${varName}' incremented by ${value}. New value: ${current + value}`);
                        }
                    } else if (operation === 'subtract') {
                        var current = player.GetVar(varName);
                        if (typeof current === 'number') {
                            player.SetVar(varName, current - value);
                            console.log(`Storyline variable '${varName}' decremented by ${value}. New value: ${current - value}`);
                        }
                    }
                } else {
                    console.warn(`Storyline Player not found. Local test mode. Variable: ${varName}, Value: ${value}, Operation: ${operation}`);
                }
            } catch (e) {
                console.error("Error communicating with Storyline: ", e);
            }
        }
    </script>

    <!-- Combined Navigation Logic -->
    <script>
        const GAMES_ORDER_NAMES = [
            'sesi_hissedelim',
            'harfi_taniyalim',
            'harfi_yazalim',
            'karda_yazalim',
            'hece_sozcuk_olusturalim',
            'sozcuk_olusturalim',
            'okuyalim'
        ];

        function getCurrentGameIndex() {
            const currentPath = window.location.pathname;
            // Handle both / and \ separators
            for (let i = 0; i < GAMES_ORDER_NAMES.length; i++) {
                if (currentPath.includes(GAMES_ORDER_NAMES[i])) {
                    return i;
                }
            }
            return -1;
        }

        function navigateHome() {
            // Storyline Logic
            try {
                var player = null;
                if (window.GetPlayer) player = window.GetPlayer();
                else if (window.parent && window.parent.GetPlayer) player = window.parent.GetPlayer();

                if (player) {
                    player.SetVar("homepage", true);
                    console.log("Storyline variable 'homepage' set to true");
                }
            } catch (e) { console.error(e); }

            // Local Logic
            window.location.href = '../../index.html';
        }

        function navigateNext() {
            // Storyline Logic
            try {
                var player = null;
                if (window.GetPlayer) player = window.GetPlayer();
                else if (window.parent && window.parent.GetPlayer) player = window.parent.GetPlayer();

                if (player) {
                    var currentId = player.GetVar("game_id");
                    if (typeof currentId === 'number') {
                        player.SetVar("game_id", currentId + 1);
                        console.log("Storyline variable 'game_id' incremented");
                    }
                }
            } catch (e) { console.error(e); }

            // Local Logic
            const idx = getCurrentGameIndex();
            if (idx !== -1 && idx < GAMES_ORDER_NAMES.length - 1) {
                window.location.href = '../' + GAMES_ORDER_NAMES[idx + 1] + '/index.html';
            } else {
                console.log("Last game or index not found.");
            }
        }

        function navigatePrev() {
            // Storyline Logic
            try {
                var player = null;
                if (window.GetPlayer) player = window.GetPlayer();
                else if (window.parent && window.parent.GetPlayer) player = window.parent.GetPlayer();

                if (player) {
                    var currentId = player.GetVar("game_id");
                    if (typeof currentId === 'number') {
                        player.SetVar("game_id", currentId - 1);
                        console.log("Storyline variable 'game_id' decremented");
                    }
                }
            } catch (e) { console.error(e); }

            // Local Logic
            const idx = getCurrentGameIndex();
            if (idx > 0) {
                window.location.href = '../' + GAMES_ORDER_NAMES[idx - 1] + '/index.html';
            } else {
                console.log("First game or index not found.");
            }
        }
    </script>


    <!-- Fullscreen & Audio Logic -->
    <script>
        // Fullscreen Toggle
        // Fullscreen Toggle (Storyline Variable)
        const btnFullscreen = document.getElementById('btn-fullscreen');
        if (btnFullscreen) {
            btnFullscreen.addEventListener('click', () => {
                try {
                    const player = window.GetPlayer ? window.GetPlayer() : (window.parent && window.parent.GetPlayer ? window.parent.GetPlayer() : null);
                    if (player) {
                        const isFull = player.GetVar("fullscreen");
                        const newState = !isFull;
                        player.SetVar("fullscreen", newState);

                        if (newState) {
                            btnFullscreen.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
                        } else {
                            btnFullscreen.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
                        }
                    }
                } catch (e) { }
            });
        }

        /* Audio Slider Logic */
        (function () {
            const btn = document.getElementById('btn-audio-toggle');
            const popup = document.getElementById('audio-slider-container');
            const range = document.getElementById('volume-range');
            const valDisplay = document.getElementById('volume-val-display');
            let isOpen = false;

            if (btn) {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    isOpen = !isOpen;
                    togglePopup(isOpen);
                });
                document.addEventListener('click', (e) => {
                    if (isOpen && popup && !popup.contains(e.target) && !btn.contains(e.target)) {
                        isOpen = false;
                        togglePopup(false);
                    }
                });
                if (popup) popup.addEventListener('click', (e) => e.stopPropagation());
            }

            function togglePopup(show) {
                if (!popup) return;
                if (show) popup.classList.add('show');
                else popup.classList.remove('show');
            }

            if (range) {
                range.addEventListener('input', function () { updateVolume(this.value, true); });

                // Init from Storyline
                try {
                    const player = window.GetPlayer ? window.GetPlayer() : (window.parent && window.parent.GetPlayer ? window.parent.GetPlayer() : null);
                    if (player) {
                        const savedVol = player.GetVar("bg_music");
                        if (typeof savedVol === 'number') {
                            range.value = savedVol;
                        }
                    }
                } catch (e) { }

                // Init UI
                updateVolume(range.value, false);
            }

            function updateVolume(val, syncToStoryline) {
                if (!range) return;
                const percent = val;
                range.style.background = `linear-gradient(to right, #f1c40f ${percent}%, #555 ${percent}%)`;
                if (valDisplay) valDisplay.innerText = val;

                // Toggle Icon
                if (btn) {
                    if (Number(val) === 0) {
                        btn.innerHTML = '<i class="bi bi-volume-mute-fill"></i>';
                    } else {
                        btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
                    }
                }

                // Storyline
                if (syncToStoryline) {
                    try {
                        const player = window.GetPlayer ? window.GetPlayer() : (window.parent && window.parent.GetPlayer ? window.parent.GetPlayer() : null);
                        if (player) {
                            player.SetVar("bg_music", Number(val));
                        }
                    } catch (e) { }
                }
            }
        })();
    </script>

</body>

</html>