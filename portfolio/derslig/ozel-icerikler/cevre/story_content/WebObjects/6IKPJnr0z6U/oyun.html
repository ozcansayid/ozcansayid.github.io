<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Çevre Uzunluğu Macerası: Çerçeveleme Sanatı</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Nunito -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        nunito: ['Nunito', 'sans-serif'],
                    },
                    colors: {
                        primary: '#03b0b9', // Başla/İleri/Onay/Doğru
                        danger: '#e50069',  // Çıkış/Hata/Yanlış
                        accent: '#fcd638',  // Vurgu/Notlar
                    }
                }
            }
        }
    </script>

    <style>
        /* Storyline Entegrasyonu için Şeffaflık Ayarları */
        html, body {
            background-color: transparent !important;
            font-family: 'Nunito', sans-serif;
            overflow-x: hidden;
            /* Mobilde seçimi ve sürüklemeyi engelle */
            user-select: none;
            -webkit-user-select: none;
            touch-action: pan-y; /* Sadece dikey kaydırmaya izin ver (canvas hariç) */
        }

        /* DÜZELTME: CSS Grid deseni kaldırıldı. Artık JS ile çizilecek. */
        .grid-bg {
            background-color: rgba(255, 255, 255, 0.95);
            /* background-image kuralları silindi */
        }

        .screen {
            display: none;
            min-height: 100vh;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.5s ease-in-out;
            background-color: transparent !important;
        }

        .content-card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        .active-screen {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Buton Stilleri */
        .btn {
            padding: 12px 32px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: none;
            outline: none;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .btn:active { transform: translateY(0); }

        .btn-primary { background-color: #03b0b9; color: white; }
        .btn-danger { background-color: #e50069; color: white; }

        /* Canvas Stili - MOBİL DÜZELTMESİ */
        canvas {
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            cursor: crosshair;
            
            /* Kritik Mobil Ayarları */
            touch-action: none; /* Canvas üzerinde tarayıcı kaydırmasını engeller */
            width: 100%;        /* Kapsayıcı genişliğine uy */
            height: auto;       /* En-boy oranını (aspect ratio) koru! */
            display: block;
        }

        /* Renkli Tablo Çerçevesi Stili */
        .portrait-frame {
            width: 220px;
            height: 300px;
            border: 15px solid #8B4513; 
            position: relative;
            background: white;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .art-content {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #fcd638 0%, #e50069 50%, #03b0b9 100%);
            position: relative;
        }
        .art-content::before {
            content: '';
            position: absolute;
            top: 20px; left: 20px;
            right: 20px; bottom: 20px;
            border: 2px solid rgba(255,255,255,0.5);
            background: radial-gradient(circle, rgba(255,255,255,0.2) 10%, transparent 10%), radial-gradient(circle, rgba(255,255,255,0.2) 10%, transparent 10%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .feedback-bubble {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="text-slate-700">

    <!-- 1. GİRİŞ EKRANI -->
    <div id="intro-screen" class="screen active-screen">
        <div class="content-card max-w-4xl w-full flex flex-col md:flex-row border border-slate-200 overflow-hidden">
            <!-- Sol: Görsel Alan -->
            <div class="md:w-1/2 p-10 bg-slate-50/50 flex flex-col items-center justify-center border-r border-slate-100 relative overflow-hidden">
                <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#03b0b9 1px, transparent 1px); background-size: 20px 20px;"></div>
                
                <div class="portrait-frame mb-4">
                    <div class="art-content"></div>
                    <div class="absolute inset-0 border-4 border-primary opacity-50 animate-pulse z-10"></div>
                </div>
                
                <div class="bg-accent text-slate-800 px-4 py-2 rounded-lg text-sm font-bold shadow-sm z-10">
                    <i class="fas fa-ruler-combined mr-2"></i>Çerçeve = Çevre
                </div>
            </div>

            <!-- Sağ: Metin Alanı -->
            <div class="md:w-1/2 p-10 flex flex-col justify-center">
                <h1 class="text-3xl font-extrabold text-slate-800 mb-4 leading-tight">
                    Çevreyi Hesaplamak:<br>
                    <span class="text-primary">Neden Önemli?</span>
                </h1>
                <p class="text-lg text-slate-600 mb-6 leading-relaxed">
                    Bir tablonun estetiğini belirleyen çerçeve, belli bir malzemeden üretilir. 
                    Çerçevenin çevre uzunluğu, kullanılan malzemenin miktarını belirler.
                </p>
                <div class="bg-blue-50 p-4 rounded-xl border-l-4 border-primary mb-8">
                    <p class="text-slate-700 font-semibold">
                        Aynı uzunluktaki çerçeve malzemesiyle kaç farklı dikdörtgen tasarlayabiliriz?
                    </p>
                </div>
                <button onclick="startGame()" class="btn btn-primary self-start">
                    BAŞLA <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 2. İNTERAKTİF ETKİNLİK EKRANI -->
    <div id="activity-screen" class="screen relative">
        <!-- Üst Bilgi Barı -->
        <div class="absolute top-4 left-0 right-0 z-50 px-6 flex justify-center md:justify-between items-start pointer-events-none">
            <!-- Sol Panel (Pointer Events Auto) -->
            <div class="bg-white/95 shadow-md p-3 rounded-xl flex items-center gap-4 border border-slate-200 pointer-events-auto">
                <div class="bg-slate-100 p-2 rounded-lg">
                    <span class="text-xs font-bold text-slate-500 block">GÖREV</span>
                    <span class="text-primary font-extrabold text-lg">Dikdörtgen Oluştur</span>
                </div>
                <div class="bg-accent/20 px-4 py-2 rounded-lg border border-accent">
                    <span class="text-sm font-bold text-slate-700">HEDEF ÇEVRE: </span>
                    <span class="text-2xl font-black text-slate-800 ml-1">16 cm</span>
                </div>
            </div>
            
            <!-- Sağ Panel -->
            <div class="hidden md:flex flex-col items-end gap-2 pointer-events-auto">
                <div class="bg-white/95 shadow-md px-4 py-2 rounded-xl border border-slate-200">
                    <p class="text-xs text-slate-400 font-bold text-right">BULUNAN ŞEKİLLER</p>
                    <div id="found-shapes-indicator" class="flex gap-1 mt-1">
                        <div class="w-8 h-2 bg-slate-200 rounded-full transition-colors" id="ind-0"></div>
                        <div class="w-8 h-2 bg-slate-200 rounded-full transition-colors" id="ind-1"></div>
                        <div class="w-8 h-2 bg-slate-200 rounded-full transition-colors" id="ind-2"></div>
                        <div class="w-8 h-2 bg-slate-200 rounded-full transition-colors" id="ind-3"></div>
                    </div>
                </div>
                <button id="next-stage-btn" onclick="startQuiz()" class="btn btn-primary opacity-50 cursor-not-allowed shadow-lg" disabled>
                    TESTE GEÇ <i class="fas fa-forward ml-2"></i>
                </button>
            </div>
        </div>

        <!-- Ana Çalışma Alanı -->
        <div class="flex flex-col items-center justify-center w-full h-full mt-24 md:mt-10">
            
            <!-- Bilgilendirme -->
            <div id="feedback-message" class="h-12 mb-2 text-center font-bold text-xl feedback-bubble opacity-0 transition-opacity">
                <!-- JS ile doldurulacak -->
            </div>

            <!-- Canvas Alanı -->
            <div class="relative w-full max-w-[800px] px-2"> <!-- Container eklendi -->
                <div class="bg-white/90 p-2 rounded-lg shadow-2xl border-4 border-slate-200 backdrop-blur-sm">
                    <!-- width ve height attribute'ları logic resolution için önemli -->
                    <canvas id="drawingCanvas" width="800" height="480" class="grid-bg"></canvas>
                    
                    <div class="absolute bottom-4 left-4 bg-white/90 px-3 py-1 rounded shadow text-xs font-bold text-slate-500 pointer-events-none">
                        <i class="fas fa-mouse-pointer mr-1"></i> Sürükleyip bırakarak çiz
                    </div>
                </div>
            </div>

            <!-- Anlık Bilgi Paneli -->
            <div class="flex gap-4 md:gap-6 mt-4 flex-wrap justify-center">
                <div class="bg-white/95 px-6 py-3 rounded-xl shadow-lg border-b-4 border-slate-200 text-center min-w-[120px]">
                    <span class="block text-xs text-slate-400 font-bold uppercase">Kısa Kenar</span>
                    <span id="display-short" class="text-2xl font-bold text-slate-700">-</span> cm
                </div>
                <div class="bg-white/95 px-6 py-3 rounded-xl shadow-lg border-b-4 border-slate-200 text-center min-w-[120px]">
                    <span class="block text-xs text-slate-400 font-bold uppercase">Uzun Kenar</span>
                    <span id="display-long" class="text-2xl font-bold text-slate-700">-</span> cm
                </div>
                <div class="bg-slate-800 px-6 py-3 rounded-xl shadow-lg border-b-4 border-black text-center min-w-[140px]">
                    <span class="block text-xs text-slate-400 font-bold uppercase">Hesaplanan Çevre</span>
                    <span id="display-perimeter" class="text-3xl font-extrabold text-white">-</span> 
                    <span class="text-white/50 text-sm">cm</span>
                </div>
            </div>
            
            <!-- Mobil için buton yedeği -->
            <button id="next-stage-btn-mobile" onclick="startQuiz()" class="md:hidden mt-4 btn btn-primary opacity-50 cursor-not-allowed w-full max-w-xs" disabled>
                TESTE GEÇ <i class="fas fa-forward ml-2"></i>
            </button>
        </div>
    </div>

    <!-- 3. ÖLÇME & DEĞERLENDİRME (QUIZ) -->
    <div id="quiz-screen" class="screen">
        <div class="max-w-2xl w-full">
            <div class="flex justify-between items-end mb-4 bg-white/80 p-4 rounded-xl backdrop-blur-sm">
                <div>
                    <span class="text-primary font-bold tracking-wider text-sm">BÖLÜM 2</span>
                    <h2 class="text-3xl font-extrabold text-slate-800">Kavrama Testi</h2>
                </div>
                <div class="bg-accent px-4 py-2 rounded-lg font-bold text-slate-800 shadow-sm">
                    Soru <span id="question-number">1</span>/4
                </div>
            </div>

            <!-- Soru Kartı -->
            <div class="content-card overflow-hidden p-8 relative border border-slate-200">
                <div class="absolute top-0 left-0 h-2 bg-slate-100 w-full">
                    <div id="quiz-progress" class="h-full bg-primary transition-all duration-500" style="width: 25%"></div>
                </div>

                <div id="quiz-content">
                    <h3 id="question-text" class="text-2xl font-bold text-slate-700 mb-8 leading-snug">
                        Soru yükleniyor...
                    </h3>
                    <div id="options-container" class="space-y-3"></div>
                </div>

                <div id="quiz-feedback" class="hidden mt-6 p-4 rounded-xl text-center font-bold text-lg animate-pulse"></div>
            </div>
        </div>
    </div>

    <!-- 4. SONUÇ EKRANI -->
    <div id="result-screen" class="screen">
        <div class="content-card text-center max-w-lg w-full p-10 border border-slate-200">
            <div class="mb-6 relative inline-block">
                <div class="absolute inset-0 bg-accent rounded-full blur-xl opacity-50 animate-pulse"></div>
                <i class="fas fa-trophy text-8xl text-primary relative z-10 drop-shadow-md"></i>
            </div>
            
            <h2 class="text-4xl font-extrabold text-slate-800 mb-2">Tebrikler!</h2>
            <p class="text-xl text-slate-500 mb-8">Etkinliği Tamamladın.</p>

            <div class="bg-slate-50 rounded-2xl p-8 border border-slate-200 shadow-inner mb-8">
                <p class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">TOPLAM PUAN</p>
                <div class="flex items-baseline justify-center gap-2">
                    <span class="text-6xl font-black text-primary mb-4" id="final-score">0</span>
                    <span class="text-2xl text-slate-400 font-bold">/ 20</span>
                </div>
                <p id="final-message" class="text-slate-700 font-semibold border-t border-slate-200 pt-4">
                    <!-- Dinamik mesaj -->
                </p>
            </div>
            
            <p class="text-xs text-slate-400 mb-2">Puan Articulate Storyline'a gönderildi.</p>
        </div>
    </div>

    <!-- JavaScript Mantığı -->
    <script>
        // --- STORYLINE ENTEGRASYONU ---
        function getStorylinePlayer() {
            try {
                if (window.parent && window.parent.GetPlayer) {
                    return window.parent.GetPlayer();
                } else if (window.parent && window.parent.parent && window.parent.parent.GetPlayer) {
                    return window.parent.parent.GetPlayer();
                }
            } catch (e) {
                console.warn("Cross-origin hatası veya Storyline bulunamadı:", e);
            }
            return null;
        }

        function updateStorylineVar(varName, value, operation = 'set') {
            const player = getStorylinePlayer();
            if (player) {
                try {
                    if (operation === 'add') {
                        let currentVal = player.GetVar(varName);
                        if (typeof currentVal === 'number') {
                            player.SetVar(varName, currentVal + value);
                        } else {
                            player.SetVar(varName, value);
                        }
                    } else {
                        player.SetVar(varName, value);
                        console.log(`Storyline: ${varName} set to ${value}`);
                    }
                } catch (e) {
                    console.error(`Storyline değişkeni (${varName}) güncellenemedi:`, e);
                }
            } else {
                console.log(`[Simülasyon Modu] Storyline Var: ${varName} | Değer: ${value}`);
            }
        }

        // --- DEĞİŞKENLER & DURUM ---
        let state = {
            screen: 'intro',
            score: 0,
            foundRectangles: [],
            drawnShapes: [],
            targetPerimeter: 16,
            gridSize: 40,
            isDrawing: false,
            startPos: { x: 0, y: 0 },
            currentRect: { w: 0, h: 0 },
            quizIndex: 0
        };

        const targetRects = [
            { a: 1, b: 7 }, 
            { a: 2, b: 6 }, 
            { a: 3, b: 5 }, 
            { a: 4, b: 4 }  
        ];

        const questions = [
            {
                text: "Bir dikdörtgenin kenar uzunlukları 8 cm ve 4 cm ise, çevre uzunluğu kaç cm'dir?",
                options: ["12 cm", "20 cm", "24 cm", "32 cm"],
                correct: 2, // 24
                explanation: "Çevre = 2 x (uzun kenar + kısa kenar) -> 2 x (8 + 4) = 24."
            },
            {
                text: "Çevre uzunluğu 40 cm olan bir dikdörtgenin, kenar uzunluklarının toplamı kaç cm olmalıdır?",
                options: ["10 cm", "20 cm", "40 cm", "80 cm"],
                correct: 1, // 20
                explanation: "Kısa kenar + uzun kenar = Çevre / 2 = 20."
            },
            {
                text: "Kenar uzunlukları doğal sayı ve çevre uzunluğu 10 cm olan kaç farklı dikdörtgen çizilebilir?",
                options: ["1 tane", "2 tane", "3 tane", "5 tane"],
                correct: 1, // 2 tane
                explanation: "a+b=5 olmalı. (1,4) ve (2,3) olmak üzere 2 farklı dikdörtgen vardır."
            },
            {
                text: "Çevre uzunluğu 32 cm olan bir karenin bir kenar uzunluğu kaç cm olmalıdır?",
                options: ["4 cm", "8 cm", "16 cm", "64 cm"],
                correct: 1, // 8
                explanation: "Kenar = 32 / 4 = 8 cm."
            }
        ];

        // --- DOM ELEMENTLERİ ---
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const feedbackEl = document.getElementById('feedback-message');
        const displayShort = document.getElementById('display-short');
        const displayLong = document.getElementById('display-long');
        const displayPerimeter = document.getElementById('display-perimeter');
        const nextStageBtn = document.getElementById('next-stage-btn');
        const nextStageBtnMob = document.getElementById('next-stage-btn-mobile');

        // --- BAŞLATMA & NAVİGASYON ---
        function startGame() {
            switchScreen('activity-screen');
            initCanvas();
            drawGrid();
            // Canvas boyutunu ve çizimi hemen güncelle
            setTimeout(drawGrid, 100);
        }

        function startQuiz() {
            switchScreen('quiz-screen');
            loadQuestion();
        }

        function showResult() {
            switchScreen('result-screen');
            document.getElementById('final-score').innerText = state.score;
            
            // --- STORYLINE SCORE UPDATE (YENİ EKLENDİ) ---
            // Storyline'da "puan" adında bir sayı değişkeni oluşturduğunuzdan emin olun.
            updateStorylineVar("puan", state.score);
            updateStorylineVar("activity_completed", true);

            let msg = "";
            if (state.score >= 18) msg = "Mükemmel! Tam puan veya ona çok yakın bir performans.";
            else if (state.score >= 12) msg = "Gayet başarılısın! Konuyu büyük ölçüde kavramışsın.";
            else msg = "Tebrikler bitirdin. Biraz daha pratik yaparak puanını artırabilirsin.";
            
            document.getElementById('final-message').innerText = msg;
        }

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
            state.screen = id;
        }

        // --- CANVAS & ÇİZİM MANTIĞI (GÜNCELLENDİ) ---
        function initCanvas() {
            // Mouse Events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);

            // Touch Events (Mobil Düzeltme)
            // passive: false -> preventDefault() çalışması için gerekli
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing, { passive: false });
        }

        // Mobil Uyumu için Geliştirilmiş Koordinat Hesaplama
        function getPointerPos(evt) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;

            // Touch veya Mouse ayrımı
            if (evt.touches && evt.touches.length > 0) {
                clientX = evt.touches[0].clientX;
                clientY = evt.touches[0].clientY;
            } else if (evt.changedTouches && evt.changedTouches.length > 0) {
                // touchend için changedTouches gerekebilir
                clientX = evt.changedTouches[0].clientX;
                clientY = evt.changedTouches[0].clientY;
            } else {
                clientX = evt.clientX;
                clientY = evt.clientY;
            }

            // Canvas'ın görsel boyutu ile gerçek (internal) boyutu arasındaki oran
            // CSS width: 100% olduğu için mobilde rect.width küçülecektir.
            // Bu oran (scaleX/Y) dokunuşu doğru canvas pikseline dönüştürür.
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function snapToGrid(val) {
            return Math.round(val / state.gridSize) * state.gridSize;
        }

        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // DÜZELTME: Izgarayı JS ile çiz (Ölçekleme sorununu çözer)
            ctx.beginPath();
            ctx.strokeStyle = '#e5e7eb'; // Tailwind slate-200 rengi
            ctx.lineWidth = 1;

            // Dikey Çizgiler
            for (let x = 0; x <= canvas.width; x += state.gridSize) {
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
            }

            // Yatay Çizgiler
            for (let y = 0; y <= canvas.height; y += state.gridSize) {
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
            }
            ctx.stroke();

            // Sabitlenmiş şekiller
            state.drawnShapes.forEach(shape => {
                ctx.beginPath();
                ctx.fillStyle = 'rgba(3, 176, 185, 0.4)'; 
                ctx.strokeStyle = '#03b0b9'; 
                ctx.lineWidth = 3;
                ctx.rect(shape.x, shape.y, shape.w, shape.h);
                ctx.fill();
                ctx.stroke();
                
                ctx.fillStyle = '#0f766e'; 
                ctx.font = 'bold 14px Nunito';
                const unitsW = Math.round(shape.w / state.gridSize);
                const unitsH = Math.round(shape.h / state.gridSize);
                if(shape.w > 20) ctx.fillText(`${unitsW}`, shape.x + shape.w/2 - 5, shape.y - 5);
                if(shape.h > 20) ctx.fillText(`${unitsH}`, shape.x - 15, shape.y + shape.h/2 + 5);
            });
        }

        function startDrawing(e) {
            // Mobilde kaydırmayı engelle
            if(e.type === 'touchstart') e.preventDefault();
            
            state.isDrawing = true;
            const pos = getPointerPos(e);
            state.startPos = { x: snapToGrid(pos.x), y: snapToGrid(pos.y) };
            feedbackEl.style.opacity = '0';
        }

        function draw(e) {
            if (!state.isDrawing) return;
            // Mobilde kaydırmayı engelle
            if(e.type === 'touchmove') e.preventDefault();
            
            const pos = getPointerPos(e);
            const currentX = snapToGrid(pos.x);
            const currentY = snapToGrid(pos.y);

            const w = Math.abs(currentX - state.startPos.x);
            const h = Math.abs(currentY - state.startPos.y);

            const unitsW = Math.round(w / state.gridSize);
            const unitsH = Math.round(h / state.gridSize);

            displayShort.innerText = Math.min(unitsW, unitsH) || 0;
            displayLong.innerText = Math.max(unitsW, unitsH) || 0;
            const perim = 2 * (unitsW + unitsH);
            displayPerimeter.innerText = perim || 0;

            drawGrid();

            ctx.beginPath();
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#3b82f6'; 
            ctx.fillStyle = 'rgba(59, 130, 246, 0.2)';
            
            const startX = Math.min(state.startPos.x, currentX);
            const startY = Math.min(state.startPos.y, currentY);
            
            ctx.rect(startX, startY, w, h);
            ctx.fill();
            ctx.stroke();

            ctx.fillStyle = '#1e293b';
            ctx.font = 'bold 16px Nunito';
            if(w > 20) ctx.fillText(`${unitsW} cm`, startX + w/2 - 20, startY - 10);
            if(h > 20) ctx.fillText(`${unitsH} cm`, startX - 45, startY + h/2 + 5);
        }

        function stopDrawing(e) {
            if (!state.isDrawing) return;
            if(e.type === 'touchend') e.preventDefault();

            state.isDrawing = false;
            
            const pos = getPointerPos(e);
            const currentX = snapToGrid(pos.x);
            const currentY = snapToGrid(pos.y);

            const w = Math.abs(currentX - state.startPos.x);
            const h = Math.abs(currentY - state.startPos.y);
            const startX = Math.min(state.startPos.x, currentX);
            const startY = Math.min(state.startPos.y, currentY);

            const unitsW = Math.round(w / state.gridSize);
            const unitsH = Math.round(h / state.gridSize);
            
            if (unitsW === 0 || unitsH === 0) {
                drawGrid();
                return;
            }

            // Doğrulama ve Storyline Değişken Güncellemesi
            if (validateRectangle(unitsW, unitsH)) {
                // DOĞRU
                updateStorylineVar("var_correct", 1, "add");
                
                state.drawnShapes.push({
                    x: startX,
                    y: startY,
                    w: w,
                    h: h
                });
                drawGrid();
            } else {
                // YANLIŞ
                drawGrid(); 
            }
        }

        // --- DOĞRULAMA MANTIĞI ---
        function validateRectangle(w, h) {
            const perimeter = 2 * (w + h);
            const small = Math.min(w, h);
            const big = Math.max(w, h);
            const shapeKey = `${small}x${big}`;

            if (perimeter === state.targetPerimeter) {
                if (state.foundRectangles.includes(shapeKey)) {
                    showFeedback("Bu dikdörtgeni zaten buldun! Farklı boyutlar dene.", "warning");
                    return false;
                } else {
                    // YENİ ve DOĞRU
                    state.foundRectangles.push(shapeKey);
                    state.score += 2; 
                    updateProgressIndicator();
                    showFeedback(`Harika! ${small}x${big} cm'lik dikdörtgen doğru.`, "success");
                    
                    if (state.foundRectangles.length === 4) {
                        setTimeout(() => {
                            showFeedback("Tebrikler! Tüm şekilleri buldun. Teste geçebilirsin.", "success");
                            nextStageBtn.disabled = false;
                            nextStageBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                            nextStageBtn.classList.add('animate-bounce');
                            
                            nextStageBtnMob.disabled = false;
                            nextStageBtnMob.classList.remove('opacity-50', 'cursor-not-allowed');
                            nextStageBtnMob.classList.add('animate-bounce');
                        }, 1000);
                    }
                    return true;
                }
            } else {
                // YANLIŞ ÇEVRE
                showFeedback(`Hata! Çevre ${perimeter} cm oldu. 16 cm olmalı.`, "error");
                updateStorylineVar("var_wrong", 1, "add"); // Storyline Yanlış Sayacı Artır
                return false;
            }
        }

        function showFeedback(msg, type) {
            feedbackEl.innerText = msg;
            feedbackEl.className = "h-12 mb-4 text-center font-bold text-lg feedback-bubble transition-opacity px-4 py-2 rounded-lg";
            feedbackEl.style.opacity = '1';
            
            if (type === 'success') {
                feedbackEl.classList.add('bg-primary', 'text-white');
            } else if (type === 'error') {
                feedbackEl.classList.add('bg-danger', 'text-white');
            } else {
                feedbackEl.classList.add('bg-accent', 'text-slate-800');
            }
        }

        function updateProgressIndicator() {
            state.foundRectangles.forEach((rect, index) => {
                const el = document.getElementById(`ind-${index}`);
                if (el) {
                    el.classList.remove('bg-slate-200');
                    el.classList.add('bg-primary');
                    el.innerHTML = '<i class="fas fa-check text-white text-[10px] flex items-center justify-center h-full"></i>';
                }
            });
        }

        // --- QUIZ MANTIĞI ---
        function loadQuestion() {
            const q = questions[state.quizIndex];
            document.getElementById('question-number').innerText = state.quizIndex + 1;
            document.getElementById('quiz-progress').style.width = `${((state.quizIndex + 1) / questions.length) * 100}%`;
            document.getElementById('question-text').innerText = q.text;
            
            const optionsDiv = document.getElementById('options-container');
            optionsDiv.innerHTML = '';
            
            document.getElementById('quiz-feedback').classList.add('hidden');

            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-xl border-2 border-slate-200 hover:border-primary hover:bg-slate-50 transition-all font-semibold text-slate-700 flex justify-between items-center group";
                btn.onclick = () => checkAnswer(idx, btn);
                
                btn.innerHTML = `
                    <span><span class="bg-slate-200 text-slate-600 px-2 py-1 rounded text-sm mr-3 group-hover:bg-primary group-hover:text-white transition-colors">${String.fromCharCode(65+idx)}</span> ${opt}</span>
                    <i class="fas fa-chevron-right text-slate-300 group-hover:text-primary"></i>
                `;
                optionsDiv.appendChild(btn);
            });
        }

        function checkAnswer(selectedIndex, btnElement) {
            const allBtns = document.getElementById('options-container').children;
            for(let btn of allBtns) btn.disabled = true;

            const q = questions[state.quizIndex];
            const feedbackBox = document.getElementById('quiz-feedback');
            feedbackBox.classList.remove('hidden');

            const storylineVarName = `var_test_${state.quizIndex + 1}`;

            if (selectedIndex === q.correct) {
                // DOĞRU
                state.score += 3;
                btnElement.classList.remove('border-slate-200');
                btnElement.classList.add('bg-primary', 'border-primary', 'text-white');
                feedbackBox.className = "mt-6 p-4 rounded-xl text-center font-bold text-lg bg-primary/10 text-primary border border-primary";
                feedbackBox.innerText = "Doğru Cevap! Harikasın.";
                
                updateStorylineVar(storylineVarName, 1);
            } else {
                // YANLIŞ
                btnElement.classList.remove('border-slate-200');
                btnElement.classList.add('bg-danger', 'border-danger', 'text-white');
                allBtns[q.correct].classList.add('bg-green-100', 'border-green-500', 'text-green-800');

                feedbackBox.className = "mt-6 p-4 rounded-xl text-center font-bold text-lg bg-danger/10 text-danger border border-danger";
                feedbackBox.innerHTML = `Yanlış Cevap. <br><span class="text-sm font-normal text-slate-600">${q.explanation}</span>`;
                
                updateStorylineVar(storylineVarName, 2);
            }

            setTimeout(() => {
                state.quizIndex++;
                if (state.quizIndex < questions.length) {
                    loadQuestion();
                } else {
                    showResult();
                }
            }, 3000);
        }

    </script>
</body>
</html>