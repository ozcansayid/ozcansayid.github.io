<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bağlama Ögeleri Sürükle Bırak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* HTML ve Body için tüm taşmaları ve boşlukları sıfırla */
        html,
        body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: transparent;
            font-family: 'Fillip', 'Nunito', sans-serif;
            touch-action: none;
            /* Sayfa genelinde kaydırmayı engelle (sürükle-bırak için) */
        }

        #scaler {
            width: 1920px;
            height: 1080px;
            transform-origin: center center;
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
            padding: 0;
        }

        #app-container {
            width: 1920px;
            height: 1080px;
            background: #FFFFFF;
            display: flex;
            flex-direction: row;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* SIDEBAR TASARIMI */
        #sidebar {
            width: 420px;
            background: #F1F5F9;
            border-right: 2px solid #E2E8F0;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            justify-content: space-between;
            margin: 0;
        }

        .status-box {
            background: #FFFFFF;
            padding: 20px;
            border-radius: 12px;
            font-size: 2.2rem;
            font-weight: 900;
            color: #1E293B;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #CBD5E1;
            white-space: nowrap;
        }

        #lives-display {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .heart {
            color: #EF4444;
            font-size: 3rem;
            line-height: 1;
        }

        .conjunction-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex-grow: 1;
            justify-content: center;
        }

        .conjunction-wrapper {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #E2E8F0;
            padding: 15px;
            border-radius: 15px;
        }

        .conjunction-item {
            position: relative;
            width: 100%;
        }

        .conjunction {
            padding: 18px;
            background: #4F46E5;
            color: white;
            border-radius: 12px;
            font-weight: 900;
            font-size: 2.2rem;
            cursor: grab;
            user-select: none;
            transition: opacity 0.2s;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            text-transform: lowercase;
            touch-action: none;
        }

        /* Pasif durum */
        .conjunction.disabled {
            opacity: 0.15 !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
            filter: grayscale(1);
        }

        .usage-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #EF4444;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            font-weight: 900;
            border: 3px solid white;
            z-index: 10;
        }

        #check-btn {
            background: #EA580C;
            color: white;
            padding: 25px;
            border-radius: 15px;
            font-size: 2.6rem;
            font-weight: 800;
            transition: all 0.3s;
            width: 100%;
            border: none;
            cursor: pointer;
            margin: 0;
        }

        #check-btn:hover:not(:disabled) {
            background: #C2410C;
        }

        /* ANA İÇERİK */
        #main-content {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-sizing: border-box;
            margin: 0;
        }

        .sentence-list {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sentence {
            width: 100%;
            font-size: 2.8rem;
            font-weight: 700;
            display: block;
            background: #F8FAFC;
            padding: 20px 30px;
            border-radius: 15px;
            border: 2px solid #E2E8F0;
            box-sizing: border-box;
            line-height: 1.6;
            text-align: left;
            transition: background 0.2s;
        }

        /* Sürükleme sırasında cümle alanı vurgusu */
        .sentence.drag-over-sentence {
            background: #E0E7FF;
            border-color: #4F46E5;
        }

        .sentence span {
            display: inline;
            vertical-align: middle;
        }

        .drop-zone {
            min-width: 180px;
            height: 70px;
            border: 3px dashed #CBD5E1;
            border-radius: 10px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            background: white;
            transition: all 0.2s;
            font-weight: 900;
            font-size: 2.4rem;
            color: #4F46E5;
            text-transform: lowercase;
            margin: 0 10px;
            vertical-align: middle;
        }

        .drop-zone.filled {
            border-style: solid;
            border-color: #4F46E5;
        }

        .drop-zone.correct {
            border-color: #22C55E !important;
            background: #F0FDF4 !important;
            color: #15803D !important;
            pointer-events: none;
        }

        .drop-zone.wrong {
            border-color: #EF4444 !important;
            background: #FEE2E2 !important;
            color: #B91C1C !important;
        }

        .idx-badge {
            opacity: 0.3;
            font-style: italic;
            font-size: 2rem;
            margin-right: 15px;
            display: inline-block;
            vertical-align: middle;
        }

        /* Mobil Sürükleme Görseli */
        .dragging-mobile {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.9;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            transform-origin: center center;
        }
    </style>
</head>

<body>

    <div id="scaler">
        <div id="app-container">
            <!-- SOL SIDEBAR -->
            <div id="sidebar">
                <div class="status-box">
                    <span>Kalan hak:</span>
                    <div id="lives-display"></div>
                </div>

                <div class="conjunction-container">
                    <!-- Gruplar -->
                    <div class="conjunction-wrapper" data-group-id="0">
                        <div class="conjunction-item">
                            <div class="conjunction" draggable="true" data-value="ve" data-group="0">ve</div>
                            <div class="usage-badge">2</div>
                        </div>
                        <div class="conjunction-item">
                            <div class="conjunction" draggable="true" data-value="ile" data-group="0">ile</div>
                            <div class="usage-badge">2</div>
                        </div>
                    </div>

                    <div class="conjunction-wrapper" data-group-id="1">
                        <div class="conjunction-item">
                            <div class="conjunction" draggable="true" data-value="veya" data-group="1">veya</div>
                            <div class="usage-badge">2</div>
                        </div>
                        <div class="conjunction-item">
                            <div class="conjunction" draggable="true" data-value="ya da" data-group="1">ya da</div>
                            <div class="usage-badge">2</div>
                        </div>
                    </div>

                    <div class="conjunction-wrapper" data-group-id="2">
                        <div class="conjunction-item">
                            <div class="conjunction" draggable="true" data-value="ama" data-group="2">ama</div>
                            <div class="usage-badge">1</div>
                        </div>
                    </div>

                    <div class="conjunction-wrapper" data-group-id="3">
                        <div class="conjunction-item">
                            <div class="conjunction" draggable="true" data-value="çünkü" data-group="3">çünkü</div>
                            <div class="usage-badge">1</div>
                        </div>
                    </div>
                </div>

                <button id="check-btn">Kontrol et</button>
            </div>

            <!-- SAĞ ANA ALAN -->
            <div id="main-content">
                <div class="sentence-list" id="sentence-list"></div>
            </div>
        </div>
    </div>

    <script>
        function updateScale() {
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            const scaler = document.getElementById('scaler');
            const scale = Math.min(winW / 1920, winH / 1080);
            scaler.style.transform = `translate(-50%, -50%) scale(${scale})`;
        }
        window.addEventListener('resize', updateScale);
        updateScale();

        const getPlayer = () => {
            try { if (window.parent && window.parent.GetPlayer) return window.parent.GetPlayer(); } catch (e) { }
            return null;
        };

        const setStoryVar = (name, val) => {
            const p = getPlayer();
            if (p) { try { p.SetVar(name, (p.GetVar(name) || 0) + val); } catch (e) { } }
        };

        const finalStoryVar = (name, val) => {
            const p = getPlayer();
            if (p) { try { p.SetVar(name, val); } catch (e) { } }
        };

        const sentencesData = [
            { text: ["Serhat resim yapmak istedi", "boya kalemleri bitmişti."], correct: ["ama"], group: 2 },
            { text: ["Bugün anneannemin evine gidelim", "evde kalıp oyun oynayalım."], correct: ["veya", "ya da"], group: 1 },
            { text: ["Kerem süt", "kurabiye aldı, kardeşiyle paylaştı."], correct: ["ve", "ile"], group: 0 },
            { text: ["Güneş bahçede sırılsıklam oldu", "bardaktan boşanırcasına yağmur yağıyordu."], correct: ["çünkü"], group: 3 },
            { text: ["Yarın sinemaya gidelim", "evde film izleyelim."], correct: ["veya", "ya da"], group: 1 },
            { text: ["Bahçede kelebekler", "arılar uçuşuyordu."], correct: ["ve", "ile"], group: 0 }
        ];

        let groupLimits = [
            { current: 0, max: 2 }, // Grup 0 (ve-ile)
            { current: 0, max: 2 }, // Grup 1 (veya-yada)
            { current: 0, max: 1 }, // Grup 2 (ama)
            { current: 0, max: 1 }  // Grup 3 (çünkü)
        ];

        let lives = 3;
        let completed = false;
        let zoneState = Array(6).fill(null);

        function init() {
            const list = document.getElementById('sentence-list');
            list.innerHTML = '';
            sentencesData.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'sentence';
                div.innerHTML = `
                <span class="idx-badge">${idx + 1}</span>
                <span>${item.text[0]}</span>
                <div class="drop-zone" data-index="${idx}"></div>
                <span>${item.text[1]}</span>
            `;
                list.appendChild(div);
            });
            updateUI();
            initMobileTouch();
        }

        function updateUI() {
            const livesDisplay = document.getElementById('lives-display');
            if (livesDisplay) {
                livesDisplay.innerHTML = Array(lives).fill('<span class="heart">❤</span>').join('');
            }

            groupLimits.forEach((g, idx) => {
                const remaining = g.max - g.current;
                const groupWrapper = document.querySelector(`.conjunction-wrapper[data-group-id="${idx}"]`);
                if (!groupWrapper) return;

                groupWrapper.querySelectorAll('.usage-badge').forEach(b => {
                    b.textContent = Math.max(0, remaining);
                });

                groupWrapper.querySelectorAll('.conjunction').forEach(btn => {
                    if (remaining <= 0) {
                        btn.classList.add('disabled');
                        btn.setAttribute('draggable', 'false');
                    } else {
                        btn.classList.remove('disabled');
                        btn.setAttribute('draggable', 'true');
                    }
                });
            });
        }

        let draggedData = null;

        // Masaüstü Sürükleme
        document.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('conjunction') && !e.target.classList.contains('disabled')) {
                draggedData = {
                    val: e.target.dataset.value,
                    group: parseInt(e.target.dataset.group)
                };
                e.target.style.opacity = '0.3';
            }
        });

        document.addEventListener('dragend', (e) => {
            if (e.target.classList.contains('conjunction')) e.target.style.opacity = '1';
        });

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            const target = e.target;
            const dz = target.closest('.drop-zone');
            const sentence = target.closest('.sentence');

            document.querySelectorAll('.sentence').forEach(s => s.classList.remove('drag-over-sentence'));

            if (dz && !dz.classList.contains('correct')) {
                dz.classList.add('drag-over');
            } else if (sentence) {
                const innerDz = sentence.querySelector('.drop-zone');
                if (innerDz && !innerDz.classList.contains('correct')) {
                    sentence.classList.add('drag-over-sentence');
                }
            }
        });

        document.addEventListener('dragleave', (e) => {
            const dz = e.target.closest('.drop-zone');
            if (dz) dz.classList.remove('drag-over');
            const sentence = e.target.closest('.sentence');
            if (sentence) sentence.classList.remove('drag-over-sentence');
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            const target = e.target;
            let dz = target.closest('.drop-zone');

            if (!dz) {
                const sentence = target.closest('.sentence');
                if (sentence) dz = sentence.querySelector('.drop-zone');
            }

            handleDropAction(dz);
            document.querySelectorAll('.sentence').forEach(s => s.classList.remove('drag-over-sentence'));
        });

        function handleDropAction(dz) {
            if (dz && !dz.classList.contains('correct') && draggedData) {
                dz.classList.remove('drag-over');
                const idx = parseInt(dz.dataset.index);

                if (zoneState[idx]) {
                    const oldGroup = zoneState[idx].group;
                    groupLimits[oldGroup].current = Math.max(0, groupLimits[oldGroup].current - 1);
                }

                zoneState[idx] = draggedData;
                groupLimits[draggedData.group].current++;

                dz.textContent = draggedData.val.toLowerCase();
                dz.classList.add('filled');
                dz.classList.remove('wrong');
                updateUI();
            }
        }

        // MOBİL DOKUNMATİK MANTIĞI
        function initMobileTouch() {
            let touchGhost = null;

            document.addEventListener('touchstart', (e) => {
                const el = e.target.closest('.conjunction');
                if (el && !el.classList.contains('disabled')) {
                    draggedData = {
                        val: el.dataset.value,
                        group: parseInt(el.dataset.group)
                    };

                    // Oyun ölçeğini hesapla
                    const scale = Math.min(window.innerWidth / 1920, window.innerHeight / 1080);

                    touchGhost = el.cloneNode(true);
                    touchGhost.classList.add('dragging-mobile');

                    // Orijinal boyutları ve oyun ölçeğini uygula
                    touchGhost.style.width = el.offsetWidth + 'px';
                    touchGhost.style.height = el.offsetHeight + 'px';
                    touchGhost.style.transform = `scale(${scale * 1.05})`; // Biraz büyüterek (hover efekti) ama oyun ölçeğinde

                    document.body.appendChild(touchGhost);

                    const touch = e.touches[0];
                    updateGhostPosition(touchGhost, touch);
                }
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (touchGhost) {
                    const touch = e.touches[0];
                    updateGhostPosition(touchGhost, touch);

                    const target = document.elementFromPoint(touch.clientX, touch.clientY);

                    document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('drag-over'));
                    document.querySelectorAll('.sentence').forEach(s => s.classList.remove('drag-over-sentence'));

                    if (target) {
                        const dz = target.closest('.drop-zone');
                        const sentence = target.closest('.sentence');

                        if (dz && !dz.classList.contains('correct')) {
                            dz.classList.add('drag-over');
                        } else if (sentence) {
                            const innerDz = sentence.querySelector('.drop-zone');
                            if (innerDz && !innerDz.classList.contains('correct')) {
                                sentence.classList.add('drag-over-sentence');
                            }
                        }
                    }
                }
            }, { passive: false });

            document.addEventListener('touchend', (e) => {
                if (touchGhost) {
                    const touch = e.changedTouches[0];
                    const target = document.elementFromPoint(touch.clientX, touch.clientY);

                    let dz = null;
                    if (target) {
                        dz = target.closest('.drop-zone');
                        if (!dz) {
                            const sentence = target.closest('.sentence');
                            if (sentence) dz = sentence.querySelector('.drop-zone');
                        }
                    }

                    handleDropAction(dz);

                    touchGhost.remove();
                    touchGhost = null;
                    document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('drag-over'));
                    document.querySelectorAll('.sentence').forEach(s => s.classList.remove('drag-over-sentence'));
                }
            });

            function updateGhostPosition(ghost, touch) {
                // Nesneyi oyun ölçeğinde parmağın biraz yukarısına yerleştir
                ghost.style.left = touch.clientX - (ghost.offsetWidth / 2) + 'px';
                ghost.style.top = touch.clientY - (ghost.offsetHeight * 1.1) + 'px';
            }
        }

        document.getElementById('check-btn').addEventListener('click', () => {
            if (completed) return;
            let correctCount = 0;
            let anyWrong = false;
            const zones = document.querySelectorAll('.drop-zone');

            zones.forEach((zone, idx) => {
                if (zone.classList.contains('correct')) { correctCount++; return; }
                const val = zone.textContent.trim().toLowerCase();
                if (val === "") return;

                if (sentencesData[idx].correct.includes(val)) {
                    zone.classList.add('correct');
                    zone.classList.remove('filled', 'wrong');
                    correctCount++;
                    setStoryVar('blank_correct', 1);
                } else {
                    zone.classList.add('wrong');
                    anyWrong = true;
                    setStoryVar('blank_wrong', 1);

                    setTimeout(() => {
                        if (!completed && !zone.classList.contains('correct')) {
                            const sIdx = parseInt(zone.dataset.index);
                            if (zoneState[sIdx]) {
                                const gIdx = zoneState[sIdx].group;
                                groupLimits[gIdx].current = Math.max(0, groupLimits[gIdx].current - 1);
                                zoneState[sIdx] = null;
                            }
                            zone.textContent = "";
                            zone.classList.remove('wrong', 'filled');
                            updateUI();
                        }
                    }, 1000);
                }
            });

            if (correctCount === 6) {
                finish(1);
            } else if (anyWrong) {
                lives--;
                updateUI();
                if (lives <= 0) finish(2);
            }
        });

        function finish(status) {
            completed = true;
            const btn = document.getElementById('check-btn');
            if (btn) {
                btn.disabled = true;
                if (status === 1) {
                    btn.textContent = "Tamamlandı";
                    btn.style.background = "#22C55E";
                } else {
                    btn.textContent = "Bitti";
                }
            }

            if (status === 2) {
                document.querySelectorAll('.drop-zone').forEach((z, i) => {
                    if (!z.classList.contains('correct')) {
                        z.textContent = sentencesData[i].correct[0];
                        z.classList.add('correct');
                    }
                });
            }
            finalStoryVar('blank_completed', status);
        }

        window.onload = init;
    </script>

</body>

</html>